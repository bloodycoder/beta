# -*- coding: cp936 -*-
import pygame
from pygame.locals import *
from lib2 import *

class Ball():
    def __init__(self,balltime,keytype):
        self.balltime = balltime
        self.keytype = keytype
        self.position = ballloc[self.keytype]

    def update(self,musictime):
        x,y = self.position
        self.position = (x,y+12)
    def render(self,surface):
        x,y = self.position
        surface.blit(ballpic,(x, y))


pygame.mixer.pre_init(44100, 16, 2, 1024*4)
pygame.init()
screen = pygame.display.set_mode((800,600), 0)
font = pygame.font.SysFont("simsun", 50, False)
pygame.mouse.set_visible(False)
clock = pygame.time.Clock()

##引用图片、音乐资源
# 定义按钮 buttons是字典
buttons = {}


mousecursor = pygame.image.load("mousecursor.png")
back = pygame.image.load("back.png")
tap = pygame.image.load("tap.png")
ballpic = pygame.image.load("ball.png")
theater = pygame.image.load("theater.png")

music = pygame.mixer.music.load("music.mp3")
TRACK_END = USEREVENT + 1
pygame.mixer.music.set_endevent(TRACK_END)

keyloc={1:(203,245),2:(300,245),3:(392,245)}
#dic ballloc is temp and to be modified
ballloc={1:(260,140),2:(352,140),3:(449,140)}
keystatus={1:False,2:False,3:False}
shifttime = 29
balls =[]
score=0
start=0
start_surface = font.render("Our Music Game",True,(255,215,0))
wait_surface = font.render("WAIT FOR 5 SECONDS",True,(255,215,0))
#keytable in 30ms with multikey no repeat
    
keytable = {51:2,64:1,70:1,77:1,83:1,90:3,96:3,103:3,109:3,115:1,122:3,128:3,135:1,141:3,147:3,154:3,160:2,167:1,173:1,179:1,186:1,192:3,199:3,205:3,211:3,218:1,224:2,231:2,237:3,244:1,250:1,256:3,263:1,269:1,276:2,282:2,288:2,295:1,301:2,308:2,314:1,320:3,327:1,333:1,340:1,346:2,353:2,359:1,365:3,372:3,375:1,378:3,381:1,385:2,388:3,391:2,394:3,397:1,401:2,404:1,407:2,410:3,413:2,417:3,420:2,423:1,429:2,436:1,442:1,449:2,455:2,461:1,468:3,474:2,481:2,487:1,500:2,506:3,510:2,513:1,516:2,519:3,522:2,526:1,538:2,551:1,564:2,577:1,583:1,590:2,596:2,603:1,615:3,622:2,628:1,635:1,641:2,647:2,654:3,667:1,673:2,679:3,686:3,692:2,699:2,705:1,718:3,724:1,731:3,737:3,744:1,750:3,756:1,763:1,769:3,776:2,782:1,788:1,795:2,801:2,808:3,814:2,820:1,827:3,833:1,840:1,846:2,853:2,859:3,865:2,872:3,878:2,885:2,891:2,897:1,904:1,910:1,917:2,923:1,929:2,936:2,942:2,949:1,955:1,961:1,968:2,974:1,981:2,987:2,994:2,1000:1,1006:1,1013:1,1019:2,1026:3,1032:2,1038:1,1045:1,1051:2,1058:2,1064:1,1070:2,1077:1,1083:2,1090:2,1096:2,1103:1,1109:1,1115:3,1122:2,1128:1,1135:2,1141:2,1147:2,1154:1,1160:1,1167:3,1173:2,1179:3,1186:2,1192:1,1199:1,1205:2,1211:2,1218:1,1237:1,1240:2,1244:3,1263:3,1266:2,1269:1,1276:2,1282:3,1288:1,1295:2,1301:2,1308:1,1314:1,1320:2,1327:1,1333:3,1340:1,1343:2,1346:3,1365:3,1369:1,1372:2,1378:3,1385:2,1391:1,1397:1,1404:1,1410:2,1417:2,1423:3,1429:3,1436:2,1442:1,1449:3,1468:1,1471:3,1474:1,1478:3,1481:2,1484:1,1487:2,1490:1,1494:3,1497:2,1500:1,1506:2,1510:3,1513:1,1519:2,1526:1,1532:3,1538:2,1545:3,1551:1,1570:1,1574:2,1577:3,1583:2,1590:3,1596:1,1603:3,1606:1,1609:3,1612:1,1615:2,1619:1,1622:2,1625:1,1628:3,1631:2,1635:1,1638:2,1641:3,1644:2,1647:1,1651:2,1654:3,1660:1,1667:3,1673:1,1679:3,1686:1,1692:3,1699:1,1705:3,1711:1,1718:3,1724:1,1731:3,1737:1,1744:3,1750:1,1756:2,1763:3,1769:2,1776:3,1782:2,1788:3,1795:2,1801:3,1808:2,1814:3,1820:2,1827:3,1833:2,1840:3,1846:1,1853:2,1859:3,1865:2,1872:1,1878:3,1885:2,1891:2,1897:1,1904:3,1910:2,1917:2,1923:1,1942:2,1945:3,1949:1,1952:2,1955:3,1958:2,1961:1,1974:2,1987:1,2000:2,2013:1,2019:2,2026:1,2032:1,2038:3,2051:3,2058:2,2064:1,2070:1,2077:2,2083:2,2090:3,2103:1,2109:2,2115:3,2122:3,2128:2,2135:2,2141:1,2154:3,2160:2,2167:1,2173:3,2179:1,2186:2,2192:3,2199:1,2205:3,2211:2,2218:1,2224:1,2231:2,2237:3,2244:2,2250:1,2256:2,2263:3,2269:1,2288:2,2308:1,2320:2,2336:3,2343:2,2349:1,2356:3,2369:1,2375:3,2388:3,2394:1,2407:2,2428:3,2431:2,2434:1,2439:2,2445:3,2452:1,2458:3,2465:1,2471:2,2478:3,2490:1,2497:1,2510:1,2522:3,2535:1,2548:3,2554:2,2561:1,2580:3,2593:1,2599:2,2606:3,2619:1,2651:3,2657:2,2663:1,2676:1,2683:3,2695:3,2708:1,2723:3,2726:2,2729:1,2732:3,2736:2,2739:1,2742:2,2769:3,2776:1,2779:2,2782:3,2788:2,2795:3,2801:1,2808:3,2811:2,2814:3,2817:2,2820:1,2827:2,2833:1,2836:2,2840:1,2843:2,2846:3,2849:2,2853:1,2856:2,2859:3,2862:2,2865:1,2869:2,2872:3,2878:1,2885:3,2888:2,2891:1,2894:2,2897:3,2904:2,2910:1,2913:2,2917:3,2920:2,2923:1,2929:3,2933:2,2936:1,2939:3,2942:2,2945:3,2949:2,2952:1,2955:3,2958:1,2961:2,2974:3,2978:3,2981:2,2984:1,2987:3,2990:3,2994:2,2997:1,3000:3,3003:2,3006:1,3010:2,3013:3,3016:2,3019:1,3022:2,3026:3,3032:1,3035:2,3038:3,3042:2,3045:1,3048:2,3051:3,3054:1,3058:2,3061:3,3064:2,3067:1,3070:3,3074:2,3077:1,3083:2,3086:1,3090:2,3093:3,3096:2,3099:1,3103:3,3106:3,3109:1,3112:1,3115:2,3119:2,3122:1,3125:1,3128:2,3135:3,3138:3,3141:2,3144:2,3147:1,3151:1,3154:2,3157:3,3160:1,3163:2,3167:3,3179:2,3186:3,3189:3,3192:2,3195:2,3199:1,3202:1,3205:2,3208:3,3211:1,3215:2,3218:3,3244:1,3256:2,3269:3,3282:2,3288:2,3295:1,3301:1,3308:2,3314:3,3320:2,3327:3,3333:1,3340:1,3346:2,3353:2,3359:3,3365:1,3372:2,3378:1,3385:2,3391:2,3397:1,3404:1,3410:1,3417:2,3423:1,3429:2,3436:1,3442:1,3449:2,3455:2,3461:2,3468:3,3474:2,3481:3,3487:2,3494:2,3500:1,3506:1,3513:1,3519:2,3526:1,3532:2,3538:1,3545:1,3551:2,3558:2,3564:3,3570:2,3577:3,3583:2,3590:2,3596:2,3603:1,3609:1,3615:2,3622:1,3628:2,3635:1,3641:1,3647:1,3654:2,3660:2,3667:1,3686:1,3689:2,3692:3,3705:1,3711:3,3715:2,3718:1,3724:2,3731:3,3737:2,3744:1,3750:2,3756:1,3763:2,3769:3,3776:1,3782:3,3788:1,3795:1,3808:3,3814:1,3817:2,3820:3,3827:2,3833:1,3840:2,3846:3,3853:1,3859:3,3865:1,3872:1,3878:2,3885:1,3891:2,3897:3,3917:2,3920:1,3923:3,3926:2,3929:1,3933:2,3936:3,3939:1,3942:3,3945:2,3949:1,3955:1,3958:2,3961:3,3968:3,3974:1,3981:2,3987:3,3994:2,4000:1,4016:1,4019:3,4022:1,4026:3,4032:2,4038:3,4045:2,4051:1,4054:2,4058:3,4061:2,4064:1,4067:2,4070:3,4074:2,4077:3,4080:2,4083:1,4086:2,4090:3,4093:2,4096:1,4099:2,4103:3,4109:3,4112:2,4115:1,4122:3,4128:1,4135:2,4141:3,4147:2,4154:2,4160:1,4167:2,4173:1,4179:3,4186:2,4192:3,4199:2,4205:1,4211:2,4218:1,4224:2,4231:3,4237:2,4244:1,4250:2,4256:3,4260:2,4263:3,4266:2,4269:1,4272:2,4276:1,4279:2,4282:3,4285:2,4288:1,4292:2,4295:3,4298:2,4301:1,4304:2,4308:3,4314:1,4320:2,4327:1,4333:2,4340:3,4346:1,4353:3,4359:1,4365:3,4372:2,4378:3,4385:1,4391:2,4397:1,4404:2,4410:3,4413:2,4417:3,4420:2,4423:1,4426:2,4429:1,4433:2,4436:3,4439:2,4442:1,4445:2,4449:3,4452:2,4455:1,4458:2,4461:3,4465:2,4468:1,4471:2,4474:1,4481:1,4487:1,4513:2,4526:2,4538:2,4545:1,4551:3,4558:2,4564:1,4570:3,4577:1,4583:2,4590:1,4596:3,4603:1,4609:2,4615:1,4622:3,4628:1,4641:1,4647:2,4651:3,4654:1,4657:2,4660:3,4663:2,4667:1,4679:2,4692:1,4705:2,4718:1,4724:2,4731:1,4737:1,4744:3,4756:3,4763:2,4769:1,4776:1,4782:2,4788:2,4795:3,4808:1,4814:2,4820:3,4827:3,4833:2,4840:2,4846:1,4859:3,4865:2,4872:1,4885:1,4891:2,4897:3,4910:3,4917:2,4923:1,4936:2,4949:2,4955:1,4961:3,4968:2,4974:1,4981:3,4987:1,4994:2,5000:1,5006:3,5013:1,5019:2,5026:1,5032:3,5038:1,5051:1,5058:2,5061:3,5064:1,5067:2,5070:3,5074:2,5077:1,5090:2,5103:1,5115:2,5128:1,5135:2,5141:1,5147:1,5154:3,5167:3,5173:2,5179:1,5186:1,5192:2,5199:2,5205:3,5218:1,5224:2,5231:3,5237:3,5244:2,5250:2,5256:1,5269:3,5276:2,5282:1,5295:1,5301:2,5308:3,5320:3,5327:2,5333:1,5340:3,5346:2,5353:3,5359:2,5372:3,5378:2,5385:1,5391:1,5397:2,5404:2,5410:3,5423:1,5429:2,5436:3,5442:3,5449:2,5455:2,5461:1,5474:3,5481:2,5487:1,5500:1,5506:2,5513:3,5526:3,5532:2,5538:1,5545:2,5551:1,5558:2,5564:3,5567:1,5570:3,5574:1,5577:3,5580:1,5583:3,5586:2,5590:1}
##引用完成


while True:
    clock.tick_busy_loop(30)
    for event in pygame.event.get():
        if event.type == QUIT:
            pygame.quit()

                
    screen.blit(back,(0,0))
    button_pressed = None
    if event.type == TRACK_END:
        start = 0
    if event.type == MOUSEBUTTONDOWN:
    # 记录鼠标点击哪个按钮
         for button_name,button in buttons.iteritems():

            if button.is_over(event.pos):
#                print button_name, "pressed"
                # print 为调试
                button_pressed = button_name
                break
        # 执行按钮的操作，不同按钮不能同时执行
    if button_pressed == "exit":
        pygame.quit()
        break

    if button_pressed == "play":
        if not pygame.mixer.music.get_busy():
            pygame.mixer.music.play()
            score = 0
#            print "play executed"
    if button_pressed == "pause":
        pygame.mixer.music.stop()
        balls = []
#鼠标操作完成

    #键盘操作开始
    try:
        keys = pygame.key.get_pressed()
        if keys[K_a]:
            keystatus[1] = True
        else:
            keystatus[1] = False
        if keys[K_s]:
            keystatus[2] = True
        else:
            keystatus[2] = False
        if keys[K_d]:
            keystatus[3] = True
        else:
            keystatus[3] = False
    except error:
        break
    #判定时间
    if pygame.mixer.music.get_busy() == True:
        musictime = pygame.mixer.music.get_pos() /30
        if musictime +shifttime in keytable:
            balls.append(Ball(musictime+shifttime,keytable[musictime+shifttime]))
        for ball in balls:
            ball.update(musictime)
            for key,status in keystatus.iteritems():
                if status == True and ball.keytype == key and ball.balltime <= musictime+1 :
                    score += 1

            if musictime >= ball.balltime+2:
                balls.remove(ball)
    #时间判定结束
    #开发用，标题为鼠标坐标        
#    pygame.display.set_caption(str(pygame.mouse.get_pos()))
    pygame.display.set_caption("Our Music Game")
    score_surface = font.render("SCORE : "+str(score)+" !",True,(255,215,0))
    screen.blit(score_surface,(350,100))
    for button in buttons.values():
        button.render(screen)
    for ball in balls:
        ball.render(screen)
    for key,status in keystatus.iteritems():
        if status == True:
            screen.blit(tap,keyloc[key])

#开始界面
    if start == 0:
        screen.blit(theater,(0,0))
        screen.blit(start_surface,(200,300))
        buttons["start"] = Button("choice1.png",(380,400))
        if buttons["start"].is_over(pygame.mouse.get_pos()):
            buttons["start"] = Button("choice1active.png",(380,400))
        if "start" in buttons:
            buttons["start"].render(screen)
        if event.type == MOUSEBUTTONDOWN:
            if buttons["start"].is_over(pygame.mouse.get_pos()):
                del buttons["start"]
                buttons["exit"] = Button("exit.png",(780,580))
                buttons["play"] = Button("play.png",(740,580))
                buttons["pause"] = Button("pause.png",(700,580))
                start = 1
                score = 0
                pygame.mixer.music.play()
                print "playing"
                if pygame.mixer.music.get_busy():
                    print "played"
    mouse_pos = pygame.mouse.get_pos()
    screen.blit(mousecursor, mouse_pos)
    pygame.display.update()
